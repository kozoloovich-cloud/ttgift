<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Missions & Rewards</title>
    <!-- Load Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font and custom styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Dynamic Gradient Background: #ff0050, #00f2ea, #000000 */
            background: linear-gradient(135deg, #ff0050 0%, #00f2ea 50%, #000000 100%);
            background-size: 400% 400%; /* Increase size for animation */
            animation: gradient-shift 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            overflow: hidden;
        }
        
        /* Keyframes for dynamic background shift */
        @keyframes gradient-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* --- Custom Gradient Text Style --- */
        .gradient-text {
            /* Gradient: #00f2ea to #ff0050 */
            background: linear-gradient(90deg, #00f2ea, #ff0050);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            /* Fallback color for browsers that don't support text fill color */
            color: #00f2ea;
        }

        /* --- iPhone Frame Styles --- */
        .iphone-frame {
            position: relative;
            /* Adjusted size for 6.1-inch feel */
            width: 450px; 
            height: 95vh; 
            max-height: 900px; /* Increased max height */
            background-color: #000; /* Black bezel */
            border-radius: 4rem; 
            padding: 10px; /* Bezel thickness */
            box-shadow: 
                0 0 0 10px #333, /* Inner metal ring */
                0 0 0 12px #555, /* Outer gloss */
                0 30px 50px rgba(0, 0, 0, 0.7); /* Deep shadow */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dynamic-island {
            position: absolute;
            top: 20px; /* Position relative to the frame top padding */
            left: 50%;
            transform: translateX(-50%);
            width: 110px;
            height: 30px;
            background-color: #000;
            border-radius: 15px;
            z-index: 50;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.9);
        }

        .app-container {
            width: 100%;
            height: 100%; 
            max-width: none; 
            max-height: none; 
            background-color: #1a1a1a; 
            box-shadow: none;
            border-radius: 3.5rem; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Ornament Styles */
        .ornament-layer {
            position: absolute;
            inset: 0;
            z-index: 5;
            /* CRITICAL FIX: Ignore all mouse/touch events on this layer */
            pointer-events: none; 
            overflow: hidden;
        }

        .ornament {
            position: absolute;
            width: 40px; 
            height: 40px;
            opacity: 0.05; 
            pointer-events: none; 
            transform: rotate(var(--rotation)); 
        }

        /* --- End iPhone Frame Styles --- */

        .mission-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #ff4486; 
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
        }
        .mission-checkbox.completed {
            background-color: #22c55e; 
            border-color: #22c55e;
            animation: pulse 0.3s ease-out;
        }
        .get-button:disabled {
            background-color: #4b5563; 
            cursor: not-allowed;
            color: #9ca3af;
        }
        /* Chest Image Animations */
        #chest-img {
            transition: transform 0.1s ease-out;
            /* UPDATED SIZE */
            width: 256px; 
            height: 256px; 
            user-select: none; 
            cursor: pointer;
        }
        #chest-img.holding {
            transform: scale(1.05);
            filter: drop-shadow(0 0 10px #facc15);
        }
        #chest-img.shaking {
            animation: shake 0.1s infinite alternate;
        }
        @keyframes shake {
            0% { transform: scale(1.05) translateX(0); }
            50% { transform: scale(1.05) translateX(5px); }
            100% { transform: scale(1.05) translateX(-5px); }
        }
        
        /* Gift Item Styles */
        .gift-item {
            transition: all 0.3s ease-out;
            opacity: 0; 
            border-radius: 0.75rem; 
            padding: 1.5rem; 
            width: 120px; 
            height: 120px; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            background-color: #2d2d2d; 
        }
        .gift-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .gift-item.selected {
            outline: 4px solid #facc15; 
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.8);
            z-index: 10;
        }
        
        /* Gift drop animation */
        .gift-item.gift-enter-active {
            animation: gift-drop 0.5s ease-out forwards;
        }
        @keyframes gift-drop {
            0% { opacity: 0; transform: translateY(-50px) scale(0.5); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* Confetti Animation Styles */
        .confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 60; 
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--confetti-color);
            opacity: 0;
            border-radius: 50%;
            animation: fall 3s ease-in forwards;
        }

        @keyframes fall {
            0% { 
                opacity: 1; 
                transform: translateY(0) rotate(0deg); 
            }
            100% { 
                opacity: 0; 
                transform: translateY(100vh) rotate(720deg); 
            }
        }
        
        /* Custom Alert Styling */
        #custom-alert {
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            padding: 1.5rem 2rem; 
            border-radius: 0.75rem;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5); 
            z-index: 55; 
            opacity: 0;
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            max-width: 90%; 
            min-width: 300px; 
            text-align: center;
            font-weight: 600;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #custom-alert.alert-show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        #custom-alert.alert-hide {
             opacity: 0;
             transform: translate(-50%, -100%) scale(0.9); 
        }

        /* Updated gifts container to use grid for better 6-item layout */
        #gifts-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem; /* Tailwind 'gap-4' equivalent */
            width: 100%;
            /* Add some max-width to the grid container if needed to keep it centered */
        }

    </style>
</head>
<body>

<!-- iPhone Frame Container -->
<div class="iphone-frame">
    <!-- Dynamic Island Simulation -->
    <div class="dynamic-island"></div>

    <div id="app" class="app-container">
        
        <!-- Ornament Background Layer (CRITICAL FIX: Added pointer-events: none in CSS class) -->
        <div id="ornament-layer" class="ornament-layer">
            <!-- 20-25 SVG ornaments added by JS on load -->
        </div>

        <!-- Confetti Container (hidden until success) -->
        <div id="confetti-container" class="confetti-container" style="display: none;"></div>
        
        <!-- Custom Alert Placeholder -->
        <div id="custom-alert"></div>

        <!-- Yellow top bar for design consistency with video -->
        <div class="bg-yellow-500 h-28 w-full absolute top-0 rounded-b-3xl transform -translate-y-1/2"></div>
        <div class="z-10 p-5 pt-16"> <!-- Adjusted pt-10 to pt-16 for margin below yellow bar -->
            <!-- Center alignment added here -->
            <h1 class="text-3xl font-black mb-10 text-center gradient-text">Daily Rewards</h1>
        </div>

        <!-- Main content container (Missions View - hidden by default now) -->
        <div id="missions-view" class="px-5 flex-grow" style="display: none;">
            <div class="w-full">
                <h2 class="text-yellow-400 text-lg font-bold mb-4">Daily Missions</h2>
                <div id="missions-list" class="space-y-4">
                    <!-- Missions will be added here by JS -->
                </div>
            </div>
        </div>

        <!-- Chest View (Shown by default now) -->
        <div id="chest-view" class="px-5 flex-grow items-center justify-center flex flex-col" style="display: flex;">
            <!-- Title applied with gradient-text class and updated text logic -->
            <h2 id="chest-title" class="text-2xl font-bold mb-8 text-center gradient-text">Your Treasure Chest!</h2>

            <!-- Chest Image Area -->
            <!-- Height adjusted to accommodate larger image, previously h-48 -->
            <div id="chest-area" class="w-full flex justify-center items-center h-64 relative"> 
                <!-- UPDATED CHEST IMAGE URL to the specific link provided in the latest request -->
                <img id="chest-img" class="w-94 h-94" 
                     src="https://i.postimg.cc/rwjMNPry/Lovepik-com-401250635-treasure-box.png" 
                     alt="Treasure Chest" 
                     onerror="this.src='https://placehold.co/256x256/ff0050/ffffff?text=LOAD+ERROR'">
                
                <!-- This element is now hidden by CSS/JS logic change -->
                <p id="hold-prompt" class="absolute bottom-0 text-gray-400 text-sm opacity-100 transition-opacity duration-300" style="display: none;">Hold for 1.2s to open</p>
            </div>

            <!-- Gifts (appear after opening) -->
            <!-- Updated to use the grid styling from the custom CSS block above -->
            <div id="gifts-container" class="mt-10 mx-auto" style="display: none;">
                <!-- Gifts will be added here by JS -->
            </div>

            <!-- Selection Message (Hidden as requested) -->
            <p id="selection-message" class="text-yellow-400 font-medium mt-4 h-6" style="display: none;"></p>
        </div>

        <!-- Footer with Action Button -->
        <div class="p-5 pt-0">
            <button id="main-action-button" onclick="handleMainAction()"
                    class="get-button w-full p-4 font-extrabold text-white text-lg rounded-xl transition-all duration-300 transform hover:scale-[1.01]"
                    disabled>
                CLAIM REWARD
            </button>
        </div>
    </div>
</div>

<!-- Username Modal (fixed position relative to viewport) -->
<div id="username-modal" class="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 transition-opacity duration-300 opacity-0 pointer-events-none">
    <div class="bg-gray-800 p-6 rounded-2xl w-full max-w-sm transform transition-transform duration-300 scale-95 shadow-2xl">
        <h3 class="text-white text-xl font-bold mb-4">Send to Account</h3>
        <p class="text-gray-400 mb-6">Enter your TikTok Username to receive the reward.</p>

        <input type="text" id="username-input" placeholder="TikTok Username"
               class="w-full p-3 mb-4 bg-gray-700 text-white rounded-lg border border-gray-600 focus:outline-none focus:border-pink-500">

        <button onclick="sendToAccount()"
                class="w-full p-3 font-bold text-white bg-pink-600 rounded-xl hover:bg-pink-700 transition-colors">
            Send
        </button>
        <button onclick="closeModal()"
                class="w-full mt-2 p-3 font-medium text-gray-400 bg-transparent rounded-xl hover:text-white transition-colors">
            Cancel
        </button>
    </div>
</div>


<script>
    // Constants for localization and images
    const TEXT_GET = "GET";
    const TEXT_CLAIM_REWARD = "SEND TO ACCOUNT"; 
    
    // SVG code for the ornament icon (TikTok logo)
    const TIKTOK_SVG = '<svg viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M8.45095 19.7926C8.60723 18.4987 9.1379 17.7743 10.1379 17.0317C11.5688 16.0259 13.3561 16.5948 13.3561 16.5948V13.2197C13.7907 13.2085 14.2254 13.2343 14.6551 13.2966V17.6401C14.6551 17.6401 12.8683 17.0712 11.4375 18.0775C10.438 18.8196 9.90623 19.5446 9.7505 20.8385C9.74562 21.5411 9.87747 22.4595 10.4847 23.2536C10.3345 23.1766 10.1815 23.0889 10.0256 22.9905C8.68807 22.0923 8.44444 20.7449 8.45095 19.7926ZM22.0352 6.97898C21.0509 5.90039 20.6786 4.81139 20.5441 4.04639H21.7823C21.7823 4.04639 21.5354 6.05224 23.3347 8.02482L23.3597 8.05134C22.8747 7.7463 22.43 7.38624 22.0352 6.97898ZM28 10.0369V14.293C28 14.293 26.42 14.2312 25.2507 13.9337C23.6179 13.5176 22.5685 12.8795 22.5685 12.8795C22.5685 12.8795 21.8436 12.4245 21.785 12.3928V21.1817C21.785 21.6711 21.651 22.8932 21.2424 23.9125C20.709 25.246 19.8859 26.1212 19.7345 26.3001C19.7345 26.3001 18.7334 27.4832 16.9672 28.28C15.3752 28.9987 13.9774 28.9805 13.5596 28.9987C13.5596 28.9987 11.1434 29.0944 8.96915 27.6814C8.49898 27.3699 8.06011 27.0172 7.6582 26.6277L7.66906 26.6355C9.84383 28.0485 12.2595 27.9528 12.2595 27.9528C12.6779 27.9346 14.0756 27.9528 15.6671 27.2341C17.4317 26.4374 18.4344 25.2543 18.4344 25.2543C18.5842 25.0754 19.4111 24.2001 19.9423 22.8662C20.3498 21.8474 20.4849 20.6247 20.4849 20.1354V11.3475C20.5435 11.3797 21.2679 11.8347 21.2679 11.8347C21.2679 11.8347 22.3179 12.4734 23.9506 12.8889C25.1204 13.1864 26.7 13.2483 26.7 13.2483V9.91314C27.2404 10.0343 27.7011 10.0671 28 10.0369Z" fill="#EE1D52"></path> <path d="M26.7009 9.91314V13.2472C26.7009 13.2472 25.1213 13.1853 23.9515 12.8879C22.3188 12.4718 21.2688 11.8337 21.2688 11.8337C21.2688 11.8337 20.5444 11.3787 20.4858 11.3464V20.1364C20.4858 20.6258 20.3518 21.8484 19.9432 22.8672C19.4098 24.2012 18.5867 25.0764 18.4353 25.2553C18.4353 25.2553 17.4337 26.4384 15.668 27.2352C14.0765 27.9539 12.6788 27.9357 12.2604 27.9539C12.2604 27.9539 9.84473 28.0496 7.66995 26.6366L7.6591 26.6288C7.42949 26.4064 7.21336 26.1717 7.01177 25.9257C6.31777 25.0795 5.89237 24.0789 5.78547 23.7934C5.78529 23.7922 5.78529 23.791 5.78547 23.7898C5.61347 23.2937 5.25209 22.1022 5.30147 20.9482C5.38883 18.9122 6.10507 17.6625 6.29444 17.3494C6.79597 16.4957 7.44828 15.7318 8.22233 15.0919C8.90538 14.5396 9.6796 14.1002 10.5132 13.7917C11.4144 13.4295 12.3794 13.2353 13.3565 13.2197V16.5948C13.3565 16.5948 11.5691 16.028 10.1388 17.0317C9.13879 17.7743 8.60812 18.4987 8.45185 19.7926C8.44534 20.7449 8.68897 22.0923 10.0254 22.991C10.1813 23.0898 10.3343 23.1775 10.4845 23.2541C10.7179 23.5576 11.0021 23.8221 11.3255 24.0368C12.631 24.8632 13.7249 24.9209 15.1238 24.3842C16.0565 24.0254 16.7586 23.2167 17.0842 22.3206C17.2888 21.7611 17.2861 21.1978 17.2861 20.6154V4.04639H20.5417C20.6763 4.81139 21.0485 5.90039 22.0328 6.97898C22.4276 7.38624 22.8724 7.7463 23.3573 8.05134C23.5006 8.19955 24.2331 8.93231 25.1734 9.38216C25.6596 9.61469 26.1722 9.79285 26.7009 9.91314Z" fill="#000000"></path> <path d="M4.48926 22.7568V22.7594L4.57004 22.9784C4.56076 22.9529 4.53074 22.8754 4.48926 22.7568Z" fill="#69C9D0"></path> <path d="M10.5128 13.7916C9.67919 14.1002 8.90498 14.5396 8.22192 15.0918C7.44763 15.7332 6.79548 16.4987 6.29458 17.354C6.10521 17.6661 5.38897 18.9168 5.30161 20.9528C5.25223 22.1068 5.61361 23.2983 5.78561 23.7944C5.78543 23.7956 5.78543 23.7968 5.78561 23.798C5.89413 24.081 6.31791 25.0815 7.01191 25.9303C7.2135 26.1763 7.42963 26.4111 7.65924 26.6334C6.92357 26.1457 6.26746 25.5562 5.71236 24.8839C5.02433 24.0451 4.60001 23.0549 4.48932 22.7626C4.48919 22.7605 4.48919 22.7584 4.48932 22.7564V22.7527C4.31677 22.2571 3.95431 21.0651 4.00477 19.9096C4.09213 17.8736 4.80838 16.6239 4.99775 16.3108C5.4985 15.4553 6.15067 14.6898 6.92509 14.0486C7.608 13.4961 8.38225 13.0567 9.21598 12.7484C9.73602 12.5416 10.2778 12.3891 10.8319 12.2934C11.6669 12.1537 12.5198 12.1415 13.3588 12.2575V13.2196C12.3808 13.2349 11.4148 13.4291 10.5128 13.7916Z" fill="#69C9D0"></path> <path d="M20.5438 4.04635H17.2881V20.6159C17.2881 21.1983 17.2881 21.76 17.0863 22.3211C16.7575 23.2167 16.058 24.0253 15.1258 24.3842C13.7265 24.923 12.6326 24.8632 11.3276 24.0368C11.0036 23.823 10.7187 23.5594 10.4844 23.2567C11.5962 23.8251 12.5913 23.8152 13.8241 23.341C14.7558 22.9821 15.4563 22.1734 15.784 21.2774C15.9891 20.7178 15.9864 20.1546 15.9864 19.5726V3H20.4819C20.4819 3 20.4315 3.41188 20.5438 4.04635ZM26.7002 8.99104V9.9131C26.1725 9.79263 25.6609 9.61447 25.1755 9.38213C24.2352 8.93228 23.5026 8.19952 23.3594 8.0513C23.5256 8.1559 23.6981 8.25106 23.8759 8.33629C25.0192 8.88339 26.1451 9.04669 26.7002 8.99104Z" fill="#69C9D0"></path> </g></svg>';
    
    // UPDATED CHEST URL: Using the specific link provided in the latest request
    const CLOSED_CHEST_URL = 'https://i.postimg.cc/rwjMNPry/Lovepik-com-401250635-treasure-box.png';
    const OPEN_CHEST_URL = CLOSED_CHEST_URL; // Using the same image for simplicity
    
    const ALL_GIFT_IMAGES = [
        // Keeping the new PostImage links for the gifts for better stability
        'https://i.postimg.cc/YqL26Rr2/1.webp', // 1
        'https://i.postimg.cc/QxKNQm88/2.webp', // 2
        'https://i.postimg.cc/jdnqHcxd/3.webp', // 3
        'https://i.postimg.cc/P5GX2Dxg/4.webp', // 4
        'https://i.postimg.cc/FHtrDSz5/5.webp', // 5
        'https://i.postimg.cc/BnWSMFbW/6.webp', // 6
        'https://i.postimg.cc/rw6VQ4s2/7.webp' // 7 
    ];

    const missions = [
        { id: 1, text: "Upload a 10-second video" },
        { id: 2, text: "Comment on 5 posts" },
        { id: 3, text: "Share a friend's profile" }
    ];

    let completedMissions = 0;
    // CHANGED: From single ID to an array of selected gift IDs
    let selectedGifts = []; 
    // UPDATED: Start on the 'chest' page, bypassing 'missions'
    let currentPage = 'chest'; 
    let isChestOpen = false;
    let holdTimer = null;
    const HOLD_DURATION = 1200; // 1.2 seconds
    let currentGifts = []; // Stores the 6 randomly selected gifts for the current session

    // DOM Elements
    const missionsView = document.getElementById('missions-view');
    const chestView = document.getElementById('chest-view');
    const missionsList = document.getElementById('missions-list');
    const mainActionButton = document.getElementById('main-action-button');
    const chestImg = document.getElementById('chest-img'); 
    const giftsContainer = document.getElementById('gifts-container');
    const holdPrompt = document.getElementById('hold-prompt');
    const usernameModal = document.getElementById('username-modal');
    const usernameInput = document.getElementById('username-input'); // Get the input element
    // Removed selectionMessage from here as it's no longer needed for text updates
    const confettiContainer = document.getElementById('confetti-container');
    const appContainer = document.getElementById('app');
    const chestArea = document.getElementById('chest-area');
    const chestTitle = document.getElementById('chest-title');
    const ornamentLayer = document.getElementById('ornament-layer');

    // --- Utility Function for Random Selection ---
    function getRandomGifts(count) {
        // Simple Fisher-Yates shuffle implementation to select 'count' unique items
        const shuffled = ALL_GIFT_IMAGES.slice(); // Create a shallow copy
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        
        // Take the first 'count' items and map them to gift objects
        return shuffled.slice(0, count).map((url, index) => ({
            id: `g${index + 1}`,
            url: url
        }));
    }

    // --- Ornament Generation ---
    function generateOrnaments() {
        // Only run if appContainer is available and has dimensions (important for offset calculation)
        if (!appContainer || appContainer.offsetWidth === 0) {
            setTimeout(generateOrnaments, 50); // Retry if not ready
            return;
        }

        const ornamentCount = 20; 
        // Use clientWidth/Height for accurate inner dimensions of the screen area
        const containerWidth = appContainer.clientWidth;
        const containerHeight = appContainer.clientHeight;
        ornamentLayer.innerHTML = ''; // Clear previous ornaments

        for (let i = 0; i < ornamentCount; i++) {
            const ornament = document.createElement('div');
            ornament.className = 'ornament';
            ornament.innerHTML = TIKTOK_SVG;

            // Random position within the container bounds
            const x = Math.random() * (containerWidth - 40); 
            const y = Math.random() * (containerHeight - 40); 
            const rotation = Math.random() * 360; // Random rotation

            ornament.style.left = `${x}px`;
            ornament.style.top = `${y}px`;
            ornament.style.setProperty('--rotation', `${rotation}deg`);

            ornamentLayer.appendChild(ornament);
        }
    }


    // --- 1. Initialization and Mission Logic ---

    function renderMissions() {
        missionsList.innerHTML = '';
        missions.forEach(mission => {
            const isCompleted = mission.completed;
            const missionItem = document.createElement('div');
            missionItem.className = 'flex items-center justify-between bg-gray-800 p-4 rounded-xl shadow-md';
            missionItem.innerHTML = `
                <p class="text-white font-medium text-base">${mission.text}</p>
                <div id="mission-${mission.id}" class="mission-checkbox ${isCompleted ? 'completed' : ''}">
                    ${isCompleted ? '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                </div>
            `;
            missionsList.appendChild(missionItem);

            const checkbox = document.getElementById(`mission-${mission.id}`);
            // Checkboxes now work reliably because ornament layer doesn't block clicks
            if (!isCompleted) {
                checkbox.onclick = () => toggleMission(mission.id);
            }
        });
        updateMainButton();
    }

    function toggleMission(id) {
        const mission = missions.find(m => m.id === id);
        if (mission && !mission.completed) {
            mission.completed = true;
            completedMissions++;
            renderMissions(); 
            checkAllMissionsCompleted();
        }
    }

    function checkAllMissionsCompleted() {
        if (completedMissions === missions.length) {
            mainActionButton.disabled = false;
            mainActionButton.classList.remove('bg-gray-400');
            mainActionButton.classList.add('bg-pink-600', 'hover:bg-pink-700');
            mainActionButton.textContent = TEXT_GET; 
        }
    }

    function updateMainButton() {
        if (currentPage === 'missions') {
            checkAllMissionsCompleted();
            if (completedMissions === missions.length) {
                mainActionButton.textContent = TEXT_GET;
            } else {
                 mainActionButton.textContent = "CLAIM REWARD"; 
            }
        } else if (currentPage === 'chest') {
            mainActionButton.textContent = "SEND TO ACCOUNT";
            // Check if at least one gift is selected
            if (isChestOpen && selectedGifts.length > 0) {
                mainActionButton.disabled = false;
                mainActionButton.classList.remove('bg-gray-400');
                mainActionButton.classList.add('bg-pink-600', 'hover:bg-pink-700');
            } else {
                // Button is disabled by default if chest isn't open or no gifts are selected
                mainActionButton.disabled = true;
                mainActionButton.classList.remove('bg-pink-600', 'hover:bg-pink-700');
                mainActionButton.classList.add('bg-gray-400');
            }
        }
    }

    // --- 2. View Switching Logic ---

    function handleMainAction() {
        if (currentPage === 'missions') {
            if (completedMissions === missions.length) {
                // Generate random gifts once on transition to chest stage
                currentGifts = getRandomGifts(6); // UPDATED: Generate 6 gifts
                
                currentPage = 'chest';
                missionsView.style.display = 'none';
                chestView.style.display = 'flex';
                // Reset selected gifts state on new chest view
                selectedGifts = []; 
                updateMainButton();
                // Ensure hold prompt is visually gone after transition
                holdPrompt.style.display = 'none'; 
            }
        } else if (currentPage === 'chest') {
            // Check if at least one gift is selected
            if (isChestOpen && selectedGifts.length > 0) {
                openModal();
            }
        }
    }

    // --- 3. Chest Logic and Hold Animation ---

    // Add event handlers to the chest image
    chestImg.addEventListener('mousedown', startHold);
    chestImg.addEventListener('mouseup', endHold);
    chestImg.addEventListener('mouseleave', endHold);
    chestImg.addEventListener('touchstart', startHold);
    chestImg.addEventListener('touchend', endHold);
    chestImg.classList.add('chest-icon'); 

    function startHold(event) {
        if (event.type === 'touchstart') event.preventDefault();

        if (isChestOpen) return;

        // Start enlarge/shake animation
        chestImg.classList.add('holding', 'shaking');
        // holdPrompt.style.opacity = '0'; // Removing opacity transition, keeping it hidden

        // Set timer
        holdTimer = setTimeout(() => {
            openChest();
        }, HOLD_DURATION);
    }

    function endHold() {
        if (isChestOpen) return;

        // Clear timer if released early
        clearTimeout(holdTimer);
        holdTimer = null;

        // Stop animation
        chestImg.classList.remove('holding', 'shaking');
        // holdPrompt.style.opacity = '1'; // Removing opacity transition, keeping it hidden
    }

    function openChest() {
        isChestOpen = true;
        chestImg.classList.remove('shaking'); 
        holdPrompt.style.display = 'none';

        // 1. Hide the chest image container
        chestArea.style.display = 'none'; 

        // 2. Change the title text content (the gradient class remains)
        chestTitle.textContent = "Your gifts!";
        
        // 3. Generate gifts
        renderGifts();
    }

    // --- 4. Gift Logic ---

    function renderGifts() {
        giftsContainer.style.display = 'grid'; // Use grid for 6 gifts
        giftsContainer.innerHTML = '';

        // UPDATED: Call getRandomGifts with 6 gifts for the initial chest view
        // NOTE: Since the missions screen is skipped, we generate them here on first load/initial state check
        if(currentGifts.length === 0) {
            currentGifts = getRandomGifts(6);
        }

        currentGifts.forEach((gift, index) => {
            // Check if this specific gift is currently selected
            const isSelected = selectedGifts.includes(gift.id);
            const giftItem = document.createElement('div');
            giftItem.id = `gift-${gift.id}`;
            // Use the array to determine the selected state
            giftItem.className = `gift-item shadow-lg transform transition-all duration-300 ${isSelected ? 'selected' : ''}`;
            giftItem.style.animationDelay = `${0.1 * index}s`; 

            // Use original external URL and add robust error handler
            giftItem.innerHTML = `
                <img src="${gift.url}" alt="TikTok Gift ${index + 1}" onerror="this.onerror=null; this.src='https://placehold.co/120x120/ff0050/fff?text=T-GIFT${index+1}'">
            `;

            giftItem.onclick = () => selectGift(gift.id);
            giftsContainer.appendChild(giftItem);

            // Trigger the drop animation
            setTimeout(() => {
                giftItem.classList.add('gift-enter-active');
            }, 50); 
        });
    }

    // CHANGED: Logic to allow multiple selections (toggle)
    function selectGift(id) {
        const index = selectedGifts.indexOf(id);

        if (index > -1) {
            // Deselect: remove from array
            selectedGifts.splice(index, 1);
        } else {
            // Select: add to array
            selectedGifts.push(id);
        }
        
        // Re-render gifts to update visuals without full page redraw
        const giftElement = document.getElementById(`gift-${id}`);
        if (giftElement) {
            giftElement.classList.toggle('selected');
        }
        
        updateMainButton();
    }
    
    // --- 5. Confetti Animation ---
    function launchConfetti() {
        confettiContainer.style.display = 'block';
        const colors = ['#ff0050', '#00f2ea', '#facc15', '#ffffff'];

        for (let i = 0; i < 50; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            
            // Random color and size
            const color = colors[Math.floor(Math.random() * colors.length)];
            const size = Math.random() * 10 + 5; 
            
            confetti.style.setProperty('--confetti-color', color);
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size}px`;
            
            // Random start position (top half of the screen)
            confetti.style.left = `${Math.random() * 100}%`;
            confetti.style.top = `${Math.random() * 20}%`; 
            
            // Random duration and delay for staggered look
            confetti.style.animationDuration = `${Math.random() * 2 + 2}s`;
            confetti.style.animationDelay = `${Math.random() * 0.5}s`;
            
            confettiContainer.appendChild(confetti);
            
            // Remove confetti after animation ends
            confetti.addEventListener('animationend', () => {
                confetti.remove();
            });
        }
        
        // Hide confetti container after a short duration
        setTimeout(() => {
            confettiContainer.style.display = 'none';
        }, 3000); 
    }


    // --- 6. Modal Logic and Sending ---

    function openModal() {
        usernameModal.classList.remove('opacity-0', 'pointer-events-none');
        usernameModal.querySelector('div').classList.remove('scale-95');
        usernameModal.querySelector('div').classList.add('scale-100');
        
        // FIX: Ensure the input is immediately focusable and receives focus
        setTimeout(() => {
            usernameInput.focus();
        }, 100); 
    }

    function closeModal() {
        usernameModal.classList.add('opacity-0', 'pointer-events-none');
        usernameModal.querySelector('div').classList.remove('scale-100');
        usernameModal.querySelector('div').classList.add('scale-95');
    }

    function sendToAccount() {
        const username = document.getElementById('username-input').value.trim();
        if (username.length < 3) {
            alertMessage('Please enter a valid Username (min. 3 characters).', 'error');
            return;
        }
        
        const selectedCount = selectedGifts.length;
        if (selectedCount === 0) {
            alertMessage('Please select at least one gift!', 'error');
            return;
        }

        // Send imitation
        closeModal();
        alertMessage(`Successfully sent ${selectedCount} gift(s) to account: ${username}!`, 'success', username, selectedCount);
        launchConfetti(); // Launch confetti on success
        
        // Optionally reset state or advance to a confirmation screen here
    }

    // Custom Alert Message
    function alertMessage(message, type = 'info', username = null, selectedCount = null) {
        const alertBox = document.getElementById('custom-alert');
        
        // Remove previous state classes
        alertBox.classList.remove('alert-show', 'alert-hide', 'bg-red-500', 'bg-green-500', 'bg-blue-500');

        // Apply new styles based on type (TikTok inspired colors)
        if (type === 'success') {
            // Custom content for success message
            alertBox.innerHTML = `
                <div class="text-3xl font-black mb-2 text-center gradient-text w-full">SUCCESS!</div>
                <p class="text-lg font-bold mb-1">ðŸŽ ${selectedCount} Gift${selectedCount > 1 ? 's' : ''} Claimed!</p>
                <p class="text-sm">Reward sent to account:</p>
                <p class="text-xl font-black mb-3 text-white">@${username}</p>
                <p class="text-xs text-gray-800">Please allow up to 5 minutes for delivery.</p>
            `;
            // TikTok success color (light green/cyan from gradient)
            alertBox.style.backgroundColor = '#00f2ea'; 
            alertBox.style.color = '#1a1a1a'; // Dark text for contrast
        } else if (type === 'error') {
            // Simple text content for error
            alertBox.textContent = message;
            // TikTok error color (bright pink/red from gradient)
            alertBox.style.backgroundColor = '#ff0050'; 
            alertBox.style.color = '#ffffff';
        } else {
            // Default info color
            alertBox.textContent = message;
            alertBox.style.backgroundColor = '#3b82f6';
            alertBox.style.color = '#ffffff';
        }

        // Show alert
        alertBox.classList.add('alert-show');

        setTimeout(() => {
            // Hide alert
            alertBox.classList.remove('alert-show');
            alertBox.classList.add('alert-hide');
            // Remove completely after animation
            setTimeout(() => {
                alertBox.classList.remove('alert-hide');
            }, 300); 
        }, 3000);
    }

    // --- 7. Startup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initial state for the button
        mainActionButton.classList.add('bg-gray-400');
        
        // Since we start on the chest screen, we need to initialize the state for the chest:
        if (currentPage === 'chest') {
            currentGifts = getRandomGifts(6); // Generate 6 gifts on startup
            // Render gifts if the chest is already open (though the current flow expects it closed initially)
            // Here we assume the chest is closed and ready for the 'hold to open' action.
            updateMainButton();
        } else {
            renderMissions();
        }
        
        generateOrnaments(); // Generate the background ornaments on load

        // Rerun ornament generation on resize to adjust positioning (optional, but good practice)
        window.addEventListener('resize', generateOrnaments);
    });

</script>

</body>
</html>
